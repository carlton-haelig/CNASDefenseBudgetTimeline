<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Budget Events Timeline</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Gotham Font Files */
        @font-face {
            font-family: "Gotham-Book";
            src: url("fonts/Gotham-Book.eot");
            src: url("fonts/Gotham-Book.eot?#iefix") format("embedded-opentype"),
                 url("fonts/Gotham-Book.woff") format("woff"),
                 url("fonts/Gotham-Book.ttf") format("truetype"),
                 url("fonts/Gotham-Book.otf") format("opentype");
        }

        @font-face {
            font-family: "Gotham-Bold";
            src: url("fonts/Gotham-Bold.eot");
            src: url("fonts/Gotham-Bold.eot?#iefix") format("embedded-opentype"),
                 url("fonts/Gotham-Bold.woff") format("woff"),
                 url("fonts/Gotham-Bold.ttf") format("truetype"),
                 url("fonts/Gotham-Bold.otf") format("opentype");
        }

        @font-face {
            font-family: "Gotham-Medium";
            src: url("fonts/Gotham-Medium.eot");
            src: url("fonts/Gotham-Medium.eot?#iefix") format("embedded-opentype"),
                 url("fonts/Gotham-Medium.woff") format("woff"),
                 url("fonts/Gotham-Medium.ttf") format("truetype"),
                 url("fonts/Gotham-Medium.otf") format("opentype");
        }

        html {
            background-color: #37373d;
        }

        body {
            padding: 1rem 1rem 1rem 4.9rem;
            color: #fff;
            font-size: 1rem;
            line-height: 1.4;
            font-family: 'Gotham-Book', 'Montserrat', 'Arial', sans-serif;
        }

        .h1 {
            font-family: 'Gotham-Bold', sans-serif;
            font-weight: 700;
            font-size: 2.4rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 3rem;
        }

        .h1__border {
            border-bottom: 0.5rem solid #fff;
            padding-bottom: 1rem;
        }

        .data-pbd { background-color: #58c1c6; }
        .data-cr { background-color: #d47371; }
        .data-gs { background-color: #7a2b2a; }
        .data-app { background-color: #ddb375; }

        .graph {
            position: relative;
            padding-left: 4rem;
            overflow-x: auto;
        }

        .graph__row {
            margin-bottom: -6px;
            white-space: nowrap;
        }

        .graph__cell {
            display: inline-block;
            width: 5rem;
            height: 4rem;
            border: 1px solid #4f4f55;
            margin-left: -5px;
        }

        .graph__cell.avg-ideal {
            background-color: #4b4b51;
            border: 1px solid #6f6f74;
        }

        .graph__row:nth-child(8) .graph__cell {
            border-bottom: 2px dashed #fff;
        }

        .graph__y-axis {
            position: absolute;
            top: 2.6rem;
            left: 0;
            width: 3.5rem;
        }

        .graph__tick--y {
            display: flex;
            align-items: center;
            height: 4rem;
            font-family: 'Gotham-Book', sans-serif;
            font-size: 0.85rem;
            color: #fff;
            text-transform: uppercase;
        }

        .graph__x-axis {
            padding-bottom: 0.5rem;
            white-space: nowrap;
        }

        .graph__tick--x {
            display: inline-block;
            width: 5rem;
            margin-left: -5px;
            text-align: center;
            cursor: pointer;
            font-family: 'Gotham-Book', sans-serif;
            font-size: 1.2rem;
            color: #fff;
            text-transform: uppercase;
            padding: 0.5rem 0;
            position: relative;
        }

        .graph__tick--x:hover .tick-x-text {
            color: #58c1c6;
        }

        .graph__tick--x.no-hover {
            cursor: default;
        }

        .graph__tick--x.no-hover:hover .tick-x-text {
            color: #fff;
        }

        .graph__data {
            display: flex;
            position: absolute;
            top: 2.8rem;
            left: 4rem;
            pointer-events: none;
        }

        .graph__datacell {
            position: absolute;
            width: 5rem;
            text-align: center;
            pointer-events: none;
        }

        .datapoint {
            display: block;
            margin: auto;
            position: relative;
            max-width: 2.2rem;
            height: 0.5rem;
            cursor: pointer;
            pointer-events: auto;
        }

        .databar {
            display: block;
            width: 0.6rem;
            margin: auto;
            pointer-events: auto;
            cursor: pointer;
        }

        .data-unknown {
            display: block;
            margin: auto;
            font-family: 'Gotham-Bold', sans-serif;
            font-size: 2rem;
            line-height: 0.9;
            color: #fff;
            pointer-events: auto;
        }

        .datapoint, .databar, .data-unknown {
            animation: data-anim ease;
        }

        .datapoint, .data-unknown {
            animation-duration: 0.3s;
        }

        .databar1 { animation-duration: 1.3s; }
        .databar2 { animation-duration: 1.6s; }
        .databar3 { animation-duration: 1.9s; }
        .databar4 { animation-duration: 2.2s; }
        .databar5 { animation-duration: 2.5s; }
        .databar6 { animation-duration: 2.8s; }
        .databar7 { animation-duration: 3.1s; }
        .databar8 { animation-duration: 3.4s; }
        .databar9 { animation-duration: 3.7s; }
        .databar10 { animation-duration: 4.0s; }

        @keyframes data-anim {
            0% {
                opacity: 0;
                max-height: 0;
                visibility: hidden;
            }
            100% {
                visibility: visible;
                opacity: 1;
                max-height: 40rem;
            }
        }

        .legend {
            float: right;
            padding-right: 10rem;
            padding-bottom: 4rem;
            margin-top: 3rem;
            clear: both;
        }

        .legend__row {
            padding-bottom: 0.5rem;
        }

        .legend__bar, .legend__text {
            display: inline-block;
        }

        .legend__bar {
            width: 2rem;
            height: 0.4rem;
        }

        .legend__bar--eofy {
            border-bottom: 2px dashed #fff;
            background: transparent;
            height: 0;
        }

        .legend__text {
            font-family: 'Gotham-Book', sans-serif;
            font-size: 0.9rem;
            padding-left: 1rem;
        }

        .tooltip {
            position: absolute;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: auto;
            top: -1.15rem;
            left: -0.9rem;
        }

        .tooltip__arrow {
            width: 4.5rem;
            height: 1rem;
            position: relative;
        }

        .tooltip__arrow::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid;
            border-bottom-color: inherit;
        }

        .tooltip__arrow.arrow-pbd::after { border-bottom-color: #58c1c6; }
        .tooltip__arrow.arrow-cr::after { border-bottom-color: #d47371; }
        .tooltip__arrow.arrow-app::after { border-bottom-color: #ddb375; }
        .tooltip__arrow.arrow-gs::after { border-bottom-color: #7a2b2a; }

        .tooltip__box {
            position: absolute;
            z-index: 1001;
            min-width: 14.5rem;
            font-family: 'Gotham-Medium', sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
            color: #fff;
            text-transform: none;
            text-align: left;
            padding: 0.6rem 0.8rem;
            box-shadow: 8px 8px 5px 0px rgba(0, 0, 0, 0.75);
            border-radius: 3px;
            top: 1rem;
            left: 4rem;
            pointer-events: auto;
        }

        .datapoint:hover .tooltip,
        .tooltip:hover {
            opacity: 1;
            visibility: visible;
        }

        .tooltip__btn {
            color: #fff;
            text-decoration: none;
            transition: color 0.2s ease;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .tooltip__btn:hover {
            color: #58c1c6;
        }

        .data-gs .tooltip__btn {
            color: #ccc;
        }

        .data-gs .tooltip__btn:hover {
            color: #fff;
        }

        .tooltip-xaxis {
            position: absolute;
            top: -2.35rem;
            left: -2.3rem;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s ease;
            pointer-events: none;
        }

        .graph__tick--x:hover .tooltip-xaxis {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-xaxis__arrow {
            width: 10rem;
            height: 2rem;
            position: relative;
        }

        .tooltip-xaxis__arrow::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #fff;
        }

        .tooltip-xaxis__box {
            position: absolute;
            top: 2rem;
            left: 8.2rem;
            background-color: #fff;
            color: #000;
            min-width: 14.5rem;
            max-width: 25rem;
            font-family: 'Gotham-Medium', sans-serif;
            font-size: 0.95rem;
            padding: 0.6rem 0.8rem;
            box-shadow: 8px 8px 5px 0px rgba(0, 0, 0, 0.75);
            border-radius: 3px;
            z-index: 1001;
        }

        #loading, #error {
            margin-left: 4rem;
            padding: 2rem;
            font-family: 'Gotham-Book', sans-serif;
        }

        #error {
            background-color: #d47371;
            color: #fff;
            border-radius: 4px;
            display: none;
        }

        .u-hidden {
            display: none !important;
            visibility: hidden;
        }

        .u-clearfix::after {
            content: "";
            display: table;
            clear: both;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .h1 {
                font-size: 1.8rem;
            }
            .legend {
                float: none;
                padding-right: 0;
            }
            .graph__cell {
                width: 3rem;
            }
            .graph__tick--x {
                width: 3rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="h1 h1__border">Federal Budget Events Timeline</div>

    <div id="loading">Loading data...</div>
    <div id="error"></div>

    <div id="visualization" class="u-hidden">
        <div class="graph">
            <div class="graph__y-axis" id="yAxis"></div>
            <div class="graph__x-axis" id="xAxis"></div>
            <div id="graphGrid"></div>
            <div class="graph__data" id="graphData"></div>
        </div>

        <div class="legend u-clearfix">
            <div class="legend__row">
                <span class="legend__bar data-pbd"></span>
                <span class="legend__text">President's Budget Delivered to Congress</span>
            </div>
            <div class="legend__row">
                <span class="legend__bar data-cr"></span>
                <span class="legend__text">Continuing Resolution</span>
            </div>
            <div class="legend__row">
                <span class="legend__bar data-app"></span>
                <span class="legend__text">Appropriation</span>
            </div>
            <div class="legend__row">
                <span class="legend__bar data-gs"></span>
                <span class="legend__text">Government Shutdown</span>
            </div>
            <div class="legend__row">
                <span class="legend__bar legend__bar--eofy"></span>
                <span class="legend__text">End of Fiscal Year</span>
            </div>
        </div>
    </div>

    <script>
        const CSV_FILE = 'data.csv';

        const eventClasses = {
            "President's Budget Delivered to Congress": 'data-pbd',
            'Continuing Resolution': 'data-cr',
            'Appropriation': 'data-app',
            'Government Shutdown': 'data-gs'
        };

        const eventColors = {
            "President's Budget Delivered to Congress": '#58c1c6',
            'Continuing Resolution': '#d47371',
            'Appropriation': '#ddb375',
            'Government Shutdown': '#7a2b2a'
        };

        const arrowClasses = {
            "President's Budget Delivered to Congress": 'arrow-pbd',
            'Continuing Resolution': 'arrow-cr',
            'Appropriation': 'arrow-app',
            'Government Shutdown': 'arrow-gs'
        };

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = [];
                let current = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                
                if (values.length >= 4) {
                    result.push(values);
                }
            }
            return result;
        }

        function parseDate(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[0] - 1, parts[1]);
        }

        function getFiscalYear(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            return month >= 9 ? year + 1 : year;
        }

        function getDayOfPeriod(date, fiscalYear) {
            const periodStart = new Date(fiscalYear - 1, 1, 1);
            const diff = date - periodStart;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function getVisualPosition(date, fiscalYear) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            // Calculate which row (0-17 for 18 months)
            // Rows 0-10: Feb-Dec of (fiscalYear-1) = 11 months
            // Rows 11-17: Jan-Jul of (fiscalYear) = 7 months
            let rowIndex;
            if (year === fiscalYear - 1) {
                // Previous calendar year (Feb-Dec)
                rowIndex = month - 1; // Feb=month 1, becomes row 0
            } else {
                // Current fiscal year's calendar year (Jan-Jul)
                rowIndex = 11 + month; // Jan=month 0, becomes row 11
            }
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const rowHeight = 4;
            const rowStartPos = rowIndex * rowHeight;
            const positionInRow = (day / daysInMonth) * rowHeight;
            
            return rowStartPos + positionInRow;
        }

        async function loadData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const visualization = document.getElementById('visualization');

            loading.style.display = 'block';
            error.style.display = 'none';
            visualization.classList.add('u-hidden');

            try {
                const response = await fetch(CSV_FILE);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.statusText}`);
                }

                const csvText = await response.text();
                const rows = parseCSV(csvText);

                if (rows.length === 0) {
                    throw new Error('No data found in CSV');
                }

                const events = [];
                const yearNotes = {};
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length >= 4) {
                        const fiscalYear = parseInt(row[1]);
                        const date = parseDate(row[2]);
                        
                        if (date) {
                            events.push({
                                fiscalYear: fiscalYear,
                                date: date,
                                dateStr: row[2],
                                eventType: row[3],
                                url: row[4] || '',
                                billName: row[5] || '',
                                dayOfPeriod: getDayOfPeriod(date, fiscalYear)
                            });
                        }
                        
                        if (row[6] && row[6].trim()) {
                            yearNotes[fiscalYear] = row[6].trim();
                        }
                    }
                }

                if (events.length === 0) {
                    throw new Error('No valid events found');
                }

                renderVisualization(events, yearNotes);

            } catch (err) {
                console.error('Error:', err);
                error.textContent = `Error: ${err.message}`;
                error.style.display = 'block';
                loading.style.display = 'none';
            }
        }

        function calculateAverageTimeline(eventsByYear) {
            const eventTimings = {
                "President's Budget Delivered to Congress": [],
                'Continuing Resolution': [],
                'Appropriation': []
            };

            Object.values(eventsByYear).forEach(yearEvents => {
                yearEvents.forEach(event => {
                    if (eventTimings[event.eventType]) {
                        eventTimings[event.eventType].push({
                            dayOfPeriod: event.dayOfPeriod,
                            date: event.date
                        });
                    }
                });
            });

            const avgEvents = [];
            for (const [eventType, timings] of Object.entries(eventTimings)) {
                if (timings.length > 0) {
                    const avgDay = Math.round(timings.reduce((a, b) => a + b.dayOfPeriod, 0) / timings.length);
                    
                    // Create date in the FIRST year of the period (fiscalYear - 1)
                    // For a reference FY, we use FY2024: period is Feb 2023 to Jul 2024
                    const refFY = 2024;
                    const avgDate = new Date(refFY - 1, 1, 1); // Feb 1, 2023
                    avgDate.setDate(avgDate.getDate() + avgDay);
                    
                    const avgDateStr = `${(avgDate.getMonth() + 1).toString().padStart(2, '0')}/${avgDate.getDate().toString().padStart(2, '0')}`;
                    
                    avgEvents.push({
                        eventType: eventType,
                        dayOfPeriod: avgDay,
                        avgDateStr: avgDateStr,
                        date: avgDate,
                        fiscalYear: refFY
                    });
                }
            }

            return avgEvents.sort((a, b) => a.dayOfPeriod - b.dayOfPeriod);
        }

        function createIdealTimeline() {
            const refFY = 2024;
            const idealBudgetDate = new Date(refFY - 1, 1, 1); // Feb 1, 2023
            const idealAppropDate = new Date(refFY - 1, 8, 30); // Sept 30, 2023
            
            return [
                { 
                    eventType: "President's Budget Delivered to Congress", 
                    dayOfPeriod: 0,
                    idealDateStr: '02/01',
                    date: idealBudgetDate,
                    fiscalYear: refFY
                },
                { 
                    eventType: 'Appropriation', 
                    dayOfPeriod: 213,
                    idealDateStr: '09/30',
                    date: idealAppropDate,
                    fiscalYear: refFY
                }
            ];
        }

        function renderVisualization(events, yearNotes) {
            const loading = document.getElementById('loading');
            const visualization = document.getElementById('visualization');
            const today = new Date();

            const eventsByYear = {};
            events.forEach(event => {
                if (!eventsByYear[event.fiscalYear]) {
                    eventsByYear[event.fiscalYear] = [];
                }
                eventsByYear[event.fiscalYear].push(event);
            });

            const years = Object.keys(eventsByYear).sort();
            
            let maxMonthsNeeded = 18;
            
            years.forEach(year => {
                const yearEvents = eventsByYear[year];
                const hasAppropriation = yearEvents.some(e => e.eventType === 'Appropriation');
                
                if (!hasAppropriation) {
                    const julyEndpoint = new Date(parseInt(year), 6, 31);
                    if (today > julyEndpoint) {
                        const periodStart = new Date(parseInt(year) - 1, 1, 1);
                        const monthsDiff = Math.floor((today - periodStart) / (1000 * 60 * 60 * 24 * 30.42));
                        maxMonthsNeeded = Math.max(maxMonthsNeeded, monthsDiff + 1);
                    }
                }
            });
            
            const numRows = maxMonthsNeeded;
            const totalHeight = numRows * 4;

            const avgEvents = calculateAverageTimeline(eventsByYear);
            const idealEvents = createIdealTimeline();

            const yAxis = document.getElementById('yAxis');
            const baseMonths = ['Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            const extendedMonths = ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            
            let months = [...baseMonths];
            if (maxMonthsNeeded > 18) {
                const additionalMonthsNeeded = maxMonthsNeeded - 18;
                for (let i = 0; i < additionalMonthsNeeded; i++) {
                    months.push(extendedMonths[i % 12]);
                }
            }
            
            let yAxisHTML = '';
            months.forEach(month => {
                yAxisHTML += `<div class="graph__tick--y"><span class="tick-y-text">${month}</span></div>`;
            });
            yAxis.innerHTML = yAxisHTML;

            const xAxis = document.getElementById('xAxis');
            let xAxisHTML = '';
            
            years.forEach(year => {
                const note = yearNotes[year] || '';
                xAxisHTML += `
                    <div class="graph__tick graph__tick--x">
                        ${note ? `
                        <div class="tooltip-xaxis">
                            <div class="tooltip-xaxis__arrow"></div>
                            <div class="tooltip-xaxis__box">${note}</div>
                        </div>
                        ` : ''}
                        <span class="tick-x-text">FY${year}</span>
                    </div>
                `;
            });
            
            xAxisHTML += `
                <div class="graph__tick graph__tick--x no-hover">
                    <span class="tick-x-text">Avg</span>
                </div>
                <div class="graph__tick graph__tick--x no-hover">
                    <span class="tick-x-text">Ideal</span>
                </div>
            `;
            xAxis.innerHTML = xAxisHTML;

            const graphGrid = document.getElementById('graphGrid');
            let gridHTML = '';
            for (let row = 0; row < numRows; row++) {
                gridHTML += '<div class="graph__row">';
                years.forEach(year => {
                    gridHTML += '<div class="graph__cell"></div>';
                });
                gridHTML += '<div class="graph__cell avg-ideal"></div>';
                gridHTML += '<div class="graph__cell avg-ideal"></div>';
                gridHTML += '</div>';
            }
            graphGrid.innerHTML = gridHTML;

            const graphData = document.getElementById('graphData');
            let dataHTML = '';
            
            years.forEach((year, yearIdx) => {
                const yearEvents = eventsByYear[year];
                yearEvents.sort((a, b) => a.dayOfPeriod - b.dayOfPeriod);
                
                const hasAppropriation = yearEvents.some(e => e.eventType === 'Appropriation');
                const leftPos = yearIdx * 5;
                let barCounter = 1;
                
                yearEvents.forEach((event, eventIdx) => {
                    const cssClass = eventClasses[event.eventType] || 'data-pbd';
                    const color = eventColors[event.eventType] || '#58c1c6';
                    const arrowClass = arrowClasses[event.eventType] || 'arrow-pbd';
                    const topPos = getVisualPosition(event.date, event.fiscalYear);
                    
                    // Debug output for positioning
                    console.log(`${event.dateStr} (${event.eventType}): topPos = ${topPos.toFixed(2)} rem`);
                    
                    let barHeight = 0;
                    if (event.eventType !== 'Appropriation') {
                        if (eventIdx < yearEvents.length - 1) {
                            const nextEvent = yearEvents[eventIdx + 1];
                            const nextTopPos = getVisualPosition(nextEvent.date, nextEvent.fiscalYear);
                            barHeight = nextTopPos - topPos;
                        } else {
                            if (!hasAppropriation) {
                                const currentTopPos = getVisualPosition(today, parseInt(year));
                                if (currentTopPos > topPos) {
                                    barHeight = currentTopPos - topPos;
                                }
                            }
                        }
                    }
                    
                    if (barHeight > 0) {
                        dataHTML += `
                            <div class="graph__datacell" style="left: ${leftPos}rem; top: ${topPos}rem;">
                                <div class="databar databar${barCounter} ${cssClass}" style="height: ${barHeight}rem; background-color: ${color};"></div>
                            </div>
                        `;
                        barCounter++;
                    }
                    
                    dataHTML += `
                        <div class="graph__datacell" style="left: ${leftPos}rem; top: ${topPos}rem;">
                            <div class="datapoint ${cssClass}">
                                <div class="tooltip">
                                    <div class="tooltip__arrow ${arrowClass}"></div>
                                    <div class="tooltip__box" style="background-color: ${color};">
                                        <strong>${event.dateStr}</strong><br>
                                        ${event.eventType}
                                        ${event.billName ? `<br><strong>Bill:</strong> ${event.billName}` : ''}
                                        ${event.url ? `<br><a href="${event.url}" target="_blank" class="tooltip__btn">Read more &gt;&gt;</a>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (!hasAppropriation) {
                    const currentTopPos = getVisualPosition(today, parseInt(year));
                    dataHTML += `
                        <div class="graph__datacell" style="left: ${leftPos}rem; top: ${currentTopPos}rem;">
                            <div class="data-unknown">?</div>
                        </div>
                    `;
                }
            });
            
            const avgLeftPos = years.length * 5;
            let avgBarCounter = 1;
            avgEvents.forEach((event, idx) => {
                const cssClass = eventClasses[event.eventType] || 'data-pbd';
                const color = eventColors[event.eventType] || '#58c1c6';
                const arrowClass = arrowClasses[event.eventType] || 'arrow-pbd';
                const topPos = getVisualPosition(event.date, event.fiscalYear);
                
                let barHeight = 0;
                if (event.eventType !== 'Appropriation' && idx < avgEvents.length - 1) {
                    const nextEvent = avgEvents[idx + 1];
                    const nextTopPos = getVisualPosition(nextEvent.date, nextEvent.fiscalYear);
                    barHeight = nextTopPos - topPos;
                }
                
                if (barHeight > 0) {
                    dataHTML += `
                        <div class="graph__datacell" style="left: ${avgLeftPos}rem; top: ${topPos}rem;">
                            <div class="databar databar${avgBarCounter} ${cssClass}" style="height: ${barHeight}rem; background-color: ${color};"></div>
                        </div>
                    `;
                    avgBarCounter++;
                }
                
                dataHTML += `
                    <div class="graph__datacell" style="left: ${avgLeftPos}rem; top: ${topPos}rem;">
                        <div class="datapoint ${cssClass}">
                            <div class="tooltip">
                                <div class="tooltip__arrow ${arrowClass}"></div>
                                <div class="tooltip__box" style="background-color: ${color};">
                                    <strong>Average: ${event.avgDateStr}</strong><br>
                                    ${event.eventType}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const idealLeftPos = (years.length + 1) * 5;
            idealEvents.forEach((event, idx) => {
                const cssClass = eventClasses[event.eventType] || 'data-pbd';
                const color = eventColors[event.eventType] || '#58c1c6';
                const arrowClass = arrowClasses[event.eventType] || 'arrow-pbd';
                const topPos = getVisualPosition(event.date, event.fiscalYear);
                
                let barHeight = 0;
                if (event.eventType !== 'Appropriation' && idx < idealEvents.length - 1) {
                    const nextEvent = idealEvents[idx + 1];
                    const nextTopPos = getVisualPosition(nextEvent.date, nextEvent.fiscalYear);
                    barHeight = nextTopPos - topPos;
                }
                
                if (barHeight > 0) {
                    dataHTML += `
                        <div class="graph__datacell" style="left: ${idealLeftPos}rem; top: ${topPos}rem;">
                            <div class="databar databar1 ${cssClass}" style="height: ${barHeight}rem; background-color: ${color};"></div>
                        </div>
                    `;
                }
                
                dataHTML += `
                    <div class="graph__datacell" style="left: ${idealLeftPos}rem; top: ${topPos}rem;">
                        <div class="datapoint ${cssClass}">
                            <div class="tooltip">
                                <div class="tooltip__arrow ${arrowClass}"></div>
                                <div class="tooltip__box" style="background-color: ${color};">
                                    <strong>Ideal: ${event.idealDateStr}</strong><br>
                                    ${event.eventType}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            graphData.innerHTML = dataHTML;
            loading.style.display = 'none';
            visualization.classList.remove('u-hidden');
        }

        loadData();
    </script>
</body>
</html>
