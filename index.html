<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Nearly Two Decades of Defense Budget Instability</title>
    
    <!--
    PRODUCTION VERSION - HARDCODED DATA
    
    This file contains all data hardcoded directly in the HTML for single-file deployment.
    
    TO UPDATE DATA:
    1. Export your updated CSV from Google Forms
    2. Find the CSV_DATA constant in the JavaScript section below (search for "HARDCODED CSV DATA")
    3. Replace the CSV_DATA string with your new export
    4. Keep the header row and all data rows
    5. Test in browser before deploying
    
    FOR CODE CHANGES:
    - Make changes to budget_viz_merged.html (which uses external data.csv)
    - Then create a new production version with updated code + hardcoded data
    
    DEPENDENCIES:
    - Gotham fonts (fonts/Gotham-*.woff and fonts/Gotham-*.ttf)
    - Update font paths to absolute URLs before embedding
    -->
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            background-color: #37373d;
        }
        @font-face {
    font-family: "Gotham-Book";
    src: url("https://s3.amazonaws.com/files.cnas.org/Budget+Graphic+v3/fonts/Gotham-Book.otf") format("opentype");
}
@font-face {
    font-family: "Gotham-Bold";
    src: url("https://s3.amazonaws.com/files.cnas.org/Budget+Graphic+v3/fonts/Gotham-Bold.otf") format("opentype");
}
@font-face {
    font-family: "Gotham-Medium";
    src: url("https://s3.amazonaws.com/files.cnas.org/Budget+Graphic+v3/fonts/Gotham-Medium.otf") format("opentype");
}

        /* ISOLATED BUDGET VISUALIZATION - All styles prefixed with #budget-viz-wrapper */
        
        #budget-viz-wrapper * { 
            box-sizing: border-box; 
        }
        
        #budget-viz-wrapper {
            background-color: #37373d;
            color: #fff;
            font-family: "Gotham-Book", sans-serif;
            padding: 2rem;
            margin: 0;
        }

        #budget-viz-wrapper .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        #budget-viz-wrapper h1 {
            font-family: "Gotham-Bold", sans-serif;
            font-size: 2.4rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin: 0 0 0.5rem 0;
            border-bottom: 0.5rem solid #fff;
            display: inline-block;
            padding-bottom: 0.3rem;
        }

        #budget-viz-wrapper .subtitle {
            margin-bottom: 2rem;
        }

        /* View Toggle Buttons */
        #budget-viz-wrapper .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        #budget-viz-wrapper .view-toggle button {
            background-color: #4b4b51;
            color: #fff;
            border: 2px solid #6f6f74;
            padding: 0.6rem 1.5rem;
            font-family: "Gotham-Medium", sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #budget-viz-wrapper .view-toggle button:hover {
            background-color: #5a5a60;
        }

        #budget-viz-wrapper .view-toggle button.active {
            background-color: #58c1c6;
            color: #000;
            border-color: #58c1c6;
        }

        #budget-viz-wrapper .u-hidden { 
            display: none !important; 
        }

        #budget-viz-wrapper #loading, 
        #budget-viz-wrapper #error {
            padding: 2rem;
            text-align: center;
        }

        #budget-viz-wrapper #error {
            background-color: #d47371;
            border-radius: 4px;
            margin-top: 2rem;
        }

        /* === TIMELINE VIEW STYLES === */
        
        #budget-viz-wrapper .timeline-container {
            padding-left: 4rem;
        }

        #budget-viz-wrapper .viz-wrapper {
            position: relative;
            margin-left: 0;
            overflow-x: auto;
            overflow-y: visible;
            padding-bottom: 2rem;
            min-width: 100%;
        }

        #budget-viz-wrapper .y-labels {
            position: absolute;
            left: 0;
            width: 3.5rem;
            text-align: right;
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #fff;
            pointer-events: none;
            z-index: 10;
        }

        #budget-viz-wrapper .y-label {
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.5rem;
            color: #fff;
            font-weight: normal;
        }

        #budget-viz-wrapper .x-labels {
            display: flex;
            margin-bottom: 0.5rem;
            min-width: max-content;
        }

        #budget-viz-wrapper .x-label {
            width: 5rem;
            text-align: center;
            font-size: 1rem;
            text-transform: uppercase;
            position: relative;
            cursor: pointer;
        }

        #budget-viz-wrapper .x-label.static {
            color: #8b8b8e;
            cursor: default;
        }

        #budget-viz-wrapper .x-tooltip {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #000;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            white-space: normal;
            width: 200px;
            text-align: left;
            font-size: 0.85rem;
            text-transform: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 100;
            margin-top: 0.5rem;
        }

        #budget-viz-wrapper .x-tooltip::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #fff;
        }

        #budget-viz-wrapper .x-label:hover .x-tooltip {
            display: block;
        }

        #budget-viz-wrapper .x-label:first-child .x-tooltip {
            left: 0;
            transform: none;
        }

        #budget-viz-wrapper .x-label:first-child .x-tooltip::before {
            left: 2.5rem;
            transform: none;
        }

        #budget-viz-wrapper .grid {
            display: grid;
            grid-template-columns: repeat(var(--cols), 5rem);
            grid-auto-rows: 4rem;
            min-width: max-content;
        }

        #budget-viz-wrapper .cell {
            border: 1px solid #4f4f55;
            position: relative;
        }

        #budget-viz-wrapper .cell.avg-ideal {
            background-color: #4b4b51;
        }

        #budget-viz-wrapper .cell.row-7 {
            border-bottom: 2px dashed #fff !important;
        }

        #budget-viz-wrapper .data-layer {
            position: absolute;
            top: 1.7rem;
            left: 0;
            width: 100%;
            pointer-events: none;
        }

        #budget-viz-wrapper .event {
            position: absolute;
            width: 5rem;
            pointer-events: auto;
        }

        #budget-viz-wrapper .marker {
            width: 2.2rem;
            height: 0.5rem;
            margin: 0 auto;
            position: relative;
            cursor: pointer;
        }

        #budget-viz-wrapper .data-pbd .marker { background-color: #58c1c6; }
        #budget-viz-wrapper .data-cr .marker { background-color: #d47371; }
        #budget-viz-wrapper .data-app .marker { background-color: #ddb375; }
        #budget-viz-wrapper .data-gs .marker { background-color: #7a2b2a; }

        #budget-viz-wrapper .bar {
            width: 0.6rem;
            margin: 0 auto;
        }

        #budget-viz-wrapper .data-pbd .bar { background-color: #58c1c6; }
        #budget-viz-wrapper .data-cr .bar { background-color: #d47371; }
        #budget-viz-wrapper .data-app .bar { background-color: #ddb375; }
        #budget-viz-wrapper .data-gs .bar { background-color: #7a2b2a; }

        #budget-viz-wrapper .question-mark {
            font-size: 1.8rem;
            text-align: center;
            color: #8b8b8e;
            line-height: 1;
            margin-top: -0.5rem;
        }

        #budget-viz-wrapper .event-tooltip {
            position: absolute;
            left: calc(100% + 0.5rem);
            top: 50%;
            transform: translateY(-50%);
            background: #fff;
            color: #000;
            padding: 0.6rem 0.8rem;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.85rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            pointer-events: none;
        }

        #budget-viz-wrapper .event:hover .event-tooltip,
        #budget-viz-wrapper .event-tooltip:hover {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        #budget-viz-wrapper .event-tooltip::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #fff;
        }

        #budget-viz-wrapper .event-tooltip a {
            color: #58c1c6;
            text-decoration: none;
        }

        #budget-viz-wrapper .legend {
            margin-top: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            font-size: 0.9rem;
        }

        #budget-viz-wrapper .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #budget-viz-wrapper .legend-bar {
            width: 2rem;
            height: 0.4rem;
        }

        #budget-viz-wrapper .legend-bar.data-pbd { background-color: #58c1c6; }
        #budget-viz-wrapper .legend-bar.data-cr { background-color: #d47371; }
        #budget-viz-wrapper .legend-bar.data-app { background-color: #ddb375; }
        #budget-viz-wrapper .legend-bar.data-gs { background-color: #7a2b2a; }
        #budget-viz-wrapper .legend-bar.eofy { 
            background: transparent; 
            border-bottom: 2px dashed #fff;
            height: 0;
        }

        /* === TABLE VIEW STYLES === */

        #budget-viz-wrapper .filters {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        #budget-viz-wrapper .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        #budget-viz-wrapper .filter-group label {
            font-family: "Gotham-Medium", sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #budget-viz-wrapper select {
            background-color: #4b4b51;
            color: #fff;
            border: 1px solid #6f6f74;
            padding: 0.6rem 2rem 0.6rem 0.8rem;
            font-family: "Gotham-Book", sans-serif;
            font-size: 0.95rem;
            border-radius: 4px;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            min-width: 180px;
        }

        #budget-viz-wrapper select:hover {
            background-color: #5a5a60;
        }

        #budget-viz-wrapper select:focus {
            outline: 2px solid #58c1c6;
            outline-offset: 2px;
        }

        #budget-viz-wrapper .clear-filters {
            background-color: #58c1c6;
            color: #000;
            border: none;
            padding: 0.6rem 1.2rem;
            font-family: "Gotham-Medium", sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end;
            transition: background-color 0.2s;
        }

        #budget-viz-wrapper .clear-filters:hover {
            background-color: #6dd1d6;
        }

        #budget-viz-wrapper .clear-filters:focus {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        #budget-viz-wrapper .result-count {
            font-size: 0.9rem;
            color: #b0b0b5;
            margin-bottom: 1rem;
        }

        #budget-viz-wrapper .table-wrapper {
            overflow-x: auto;
            background-color: #2d2d32;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        #budget-viz-wrapper table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        #budget-viz-wrapper thead {
            background-color: #1f1f24;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #budget-viz-wrapper th {
            padding: 1rem;
            text-align: left;
            font-family: "Gotham-Medium", sans-serif;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #4f4f55;
            white-space: nowrap;
        }

        #budget-viz-wrapper th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem;
        }

        #budget-viz-wrapper th.sortable:hover {
            background-color: #2a2a30;
        }

        #budget-viz-wrapper th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
        }

        #budget-viz-wrapper th.sortable.sorted-asc::after {
            content: '↑';
            opacity: 1;
        }

        #budget-viz-wrapper th.sortable.sorted-desc::after {
            content: '↓';
            opacity: 1;
        }

        #budget-viz-wrapper tbody tr {
            border-bottom: 1px solid #3f3f45;
        }

        #budget-viz-wrapper tbody tr:hover {
            background-color: #37373d;
        }

        #budget-viz-wrapper td {
            padding: 1rem;
            vertical-align: top;
        }

        #budget-viz-wrapper td.date {
            white-space: nowrap;
            font-family: "Gotham-Medium", sans-serif;
        }

        #budget-viz-wrapper td.fy {
            white-space: nowrap;
            text-align: center;
            position: relative;
        }

        #budget-viz-wrapper .fy-with-note {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            position: relative;
        }

        #budget-viz-wrapper .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1rem;
            height: 1rem;
            background-color: #58c1c6;
            color: #000;
            border-radius: 50%;
            font-size: 0.7rem;
            font-family: "Gotham-Bold", sans-serif;
            cursor: help;
            position: relative;
        }

        #budget-viz-wrapper .fy-tooltip {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            color: #000;
            padding: 0.6rem 0.8rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            min-width: 200px;
            max-width: 300px;
            font-size: 0.85rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            margin-top: 0.5rem;
            white-space: normal;
            text-align: left;
            pointer-events: none;
        }

        #budget-viz-wrapper .fy-tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #fff;
        }

        #budget-viz-wrapper .info-icon:hover .fy-tooltip {
            opacity: 1;
            visibility: visible;
        }

        #budget-viz-wrapper td.event-type {
            position: relative;
            padding-left: 1.8rem;
        }

        #budget-viz-wrapper td.event-type::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 2px;
        }

        #budget-viz-wrapper td.event-type.data-pbd::before {
            background-color: #58c1c6;
        }

        #budget-viz-wrapper td.event-type.data-cr::before {
            background-color: #d47371;
        }

        #budget-viz-wrapper td.event-type.data-app::before {
            background-color: #ddb375;
        }

        #budget-viz-wrapper td.event-type.data-gs::before {
            background-color: #7a2b2a;
        }

        #budget-viz-wrapper td.bill {
            font-style: italic;
            color: #b0b0b5;
        }

        #budget-viz-wrapper td.source a {
            color: #58c1c6;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        #budget-viz-wrapper td.source a:hover {
            border-bottom-color: #58c1c6;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            #budget-viz-wrapper {
                padding: 1rem 0.5rem;
            }

            #budget-viz-wrapper .timeline-container {
                padding-left: 3rem;
                min-width: 900px;
            }

            #budget-viz-wrapper h1 {
                font-size: 1.5rem;
            }

            #budget-viz-wrapper .legend {
                gap: 0.8rem;
                font-size: 0.75rem;
                margin-top: 1rem;
                margin-bottom: 1.5rem;
            }

            #budget-viz-wrapper .legend-bar {
                width: 1.5rem;
                height: 0.3rem;
            }

            #budget-viz-wrapper .y-labels {
                left: 0.5rem;
                width: 2.5rem;
                font-size: 0.7rem;
            }

            #budget-viz-wrapper .y-label {
                padding-right: 0.2rem;
            }

            #budget-viz-wrapper .x-labels {
                font-size: 0.9rem;
            }

            #budget-viz-wrapper .viz-wrapper {
                overflow-x: scroll;
                -webkit-overflow-scrolling: touch;
            }

            #budget-viz-wrapper .timeline-container::before {
                content: '← Scroll horizontally to view all fiscal years →';
                display: block;
                text-align: center;
                font-size: 0.8rem;
                color: #58c1c6;
                margin-bottom: 1rem;
                font-style: italic;
            }

            #budget-viz-wrapper .filters {
                gap: 1rem;
            }

            #budget-viz-wrapper .filter-group {
                width: 100%;
            }

            #budget-viz-wrapper select {
                width: 100%;
                min-width: 0;
            }

            #budget-viz-wrapper .clear-filters {
                width: 100%;
            }

            #budget-viz-wrapper table {
                font-size: 0.85rem;
            }

            #budget-viz-wrapper th,
            #budget-viz-wrapper td {
                padding: 0.75rem 0.5rem;
            }

            #budget-viz-wrapper .fy-tooltip {
                max-width: 250px;
                font-size: 0.8rem;
            }

            #budget-viz-wrapper .view-toggle {
                flex-direction: column;
            }

            #budget-viz-wrapper .view-toggle button {
                width: 100%;
            }
        }

        @media (max-width: 768px) and (orientation: landscape) {
            #budget-viz-wrapper .timeline-container::before {
                content: '';
                display: none;
            }
            
            #budget-viz-wrapper .legend {
                flex-wrap: nowrap;
                gap: 1rem;
                font-size: 0.7rem;
                overflow-x: auto;
            }
            
            #budget-viz-wrapper .legend-item {
                white-space: nowrap;
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>
    <div id="budget-viz-wrapper">
        <div class="container">
            <div class="subtitle">
                <h1>NEARLY TWO DECADES OF DEFENSE BUDGET INSTABILITY</h1>
            </div>

            <div class="view-toggle">
                <button id="timeline-btn" class="active">Timeline View</button>
                <button id="table-btn">Table View</button>
            </div>

            <div id="loading">Loading data...</div>
            <div id="error" class="u-hidden"></div>

            <!-- TIMELINE VIEW -->
            <div id="timeline-view" class="u-hidden">
                <div id="legend-placeholder"></div>
                <div class="timeline-container">
                    <div id="viz"></div>
                </div>
            </div>

            <!-- TABLE VIEW -->
            <div id="table-view" class="u-hidden">
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-fy">Fiscal Year</label>
                        <select id="filter-fy">
                            <option value="">All Fiscal Years</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filter-event">Event Type</label>
                        <select id="filter-event">
                            <option value="">All Event Types</option>
                        </select>
                    </div>

                    <button class="clear-filters" id="clear-filters">Clear Filters</button>
                </div>

                <div class="result-count" id="result-count"></div>

                <div id="table-container">
                    <div class="table-wrapper">
                        <table id="data-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="date">Date</th>
                                    <th>Fiscal Year</th>
                                    <th class="sortable" data-sort="event">Event Type</th>
                                    <th>Bill Name</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // HARDCODED CSV DATA FOR PRODUCTION
        // To update data: Replace the CSV_DATA string below with your updated CSV export from Google Forms
        // Format: Keep the header row, then one row per event with columns:
        // Timestamp, Fiscal Year, Date (MM/DD/YYYY), Event Type, Source URL, Bill Name, FY Note
        
        const CSV_DATA = `Timestamp,Fiscal Year,Date,Event Type,Source URL,Bill Name (if applicable),Input note for the FY
11/20/2025 12:00:00,2026,11/20/2025,Continuing Resolution,https://www.congress.gov/bill/119th-congress/house-bill/5371,H.R. 5371,
10/29/2025 15:33:45,2026,05/02/2025,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2026-BUD/pdf/BUDGET-2026-BUD.pdf,,"""DOD started FY2026 under a shutdown. The government remains shutdown at the time data collection"""
10/29/2025 15:34:35,2026,10/01/2025,Government Shutdown,https://www.cbsnews.com/live-updates/government-shutdown-latest-snap-benefits-impasse/,,
10/29/2025 15:31:29,2025,03/11/2024,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2025-BUD/pdf/BUDGET-2025-BUD.pdf,,"""DoD's FY25 budget was funded by two short-term CRs and a third full-year CR"""
10/29/2025 15:32:23,2025,03/15/2025,Full-Year Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2025,H.R. 1968,
10/29/2025 15:31:47,2025,09/26/2024,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2025,H.R. 9747,
10/29/2025 15:32:07,2025,12/21/2024,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2025,H.R. 10545,
10/29/2025 15:30:13,2024,01/19/2024,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 2782,
10/29/2025 15:30:32,2024,03/01/2024,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 7463,
10/29/2025 15:28:52,2024,03/09/2023,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2024-BUD/pdf/BUDGET-2024-BUD.pdf,,"""DoD started FY24 under a CR and continued with four additional CRs before the Consolidated Appropriations Act became Law in December"""
10/29/2025 15:30:59,2024,03/23/2024,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 2882,
10/29/2025 15:29:17,2024,09/30/2023,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 5860,
10/29/2025 15:29:48,2024,11/16/2023,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 6363,
10/29/2025 15:27:24,2023,03/28/2022,President's Budget Delivered to Congress,https://www.govinfo.gov/app/collection/budget/2023,,"""DoD started FY23 under a CR and continued with three additional CRs before the Consolidated Appropriations Act became Law in December"""
10/29/2025 15:27:41,2023,09/30/2022,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2023,H.R. 6833,
10/29/2025 15:28:01,2023,12/16/2022,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2023,H.R. 1487,
10/29/2025 15:28:19,2023,12/23/2022,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2023,H.R. 2617,
,2024,03/23/2024,Appropriation,https://www.congress.gov/crs-appropriations-status-table/2024,H.R. 2882,
10/29/2025 15:28:33,2023,12/29/2022,Appropriation,https://www.congress.gov/crs-appropriations-status-table/2023,H.R. 2617,
10/29/2025 15:26:29,2022,02/18/2022,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2022,H.R. 6617,
10/29/2025 15:26:47,2022,03/11/2022,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2022,H.J. Res 75,
10/29/2025 15:27:02,2022,03/15/2022,Appropriation,https://www.congress.gov/crs-appropriations-status-table/2022,H.R. 2471,
10/29/2025 15:25:28,2022,05/28/2021,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2022-BUD/pdf/BUDGET-2022-BUD.pdf,,"""DoD started FY22 under a CR and continued with four additional CRs before the Consolidated Appropriations Act became Law in March"""
10/29/2025 15:25:43,2022,09/30/2021,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2022,H.R. 5305,
10/29/2025 15:26:07,2022,12/03/2021,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2022,H.R. 6119,
10/29/2025 15:22:57,2021,02/10/2020,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2021-BUD/pdf/BUDGET-2021-BUD.pdf,,"""DoD started FY21 under a CR and continued with five additional CRs before the Consolidated Appropriations Act became Law in December"""
10/29/2025 15:23:21,2021,10/01/2020,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2021,H.R. 8319,
10/29/2025 15:23:35,2021,12/11/2020,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2021,H.R. 8900,
10/29/2025 15:23:52,2021,12/18/2020,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2021,H.J. Res 107,
10/29/2025 15:24:17,2021,12/20/2020,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2021,H.J. Res 110,
10/29/2025 15:24:31,2021,12/22/2020,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2021,H.R. 1520,
10/29/2025 15:25:05,2021,12/27/2020,Appropriation,https://www.congress.gov/crs-appropriations-status-table/2021,H.R. 133,
10/29/2025 15:21:49,2020,03/11/2019,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2020-BUD/pdf/BUDGET-2020-BUD.pdf,,"""DOD Started FY2020 under a CR and continued with two additional CRs before the Consolidated Appropriations Act became Law in December"""
10/29/2025 15:22:13,2020,09/27/2019,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2020,H.R. 4378,
10/29/2025 15:22:35,2020,11/21/2019,Continuing Resolution,https://www.congress.gov/crs-appropriations-status-table/2020,H.R. 3055,
10/29/2025 15:20:59,2019,02/12/2018,President's Budget Delivered to Congress,https://www.govinfo.gov/content/pkg/BUDGET-2019-BUD/pdf/BUDGET-2019-BUD.pdf,,"""While other parts of the government started under CR, DoD's FY19 appropriations passed on time. The December 2018-January 2019 shutdown did not directly affect DoD spending"""
,2020,12/20/2019,Appropriation,https://www.congress.gov/crs-appropriations-status-table/2020,HR. 1158,
10/29/2025 15:21:20,2019,09/28/2018,Appropriation,https://www.congress.gov/bill/115th-congress/house-bill/6157,H.R. 6157,
10/29/2025 15:19:28,2018,01/20/2018,Government Shutdown,https://www.congress.gov/crs-product/RL34680,,
10/29/2025 15:19:45,2018,01/22/2018,Continuing Resolution,https://www.congress.gov/115/plaws/publ120/PLAW-115publ120.pdf,H.R. 195,
10/29/2025 15:20:06,2018,02/09/2018,Continuing Resolution,https://www.congress.gov/115/plaws/publ123/PLAW-115publ123.pdf,H.R. 1892,
10/29/2025 15:20:35,2018,03/23/2018,Appropriation,https://www.congress.gov/bill/115th-congress/house-bill/1625/text,H.R. 1625,
10/29/2025 15:17:04,2018,05/23/2017,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2018-BUD/pdf/BUDGET-2018-BUD.pdf,,"""DoD started FY18 under a CR and continued with five additional CRs before the Consolidated Appropriations Act became Law in March"""
10/29/2025 15:18:08,2018,09/08/2017,Continuing Resolution,https://www.congress.gov/bill/115th-congress/house-bill/601?q=%7B%22search%22%3A%5B%22h.r.601%22%5D%7D&r=1,H.R. 601,
10/29/2025 15:18:32,2018,12/08/2017,Continuing Resolution,https://www.govinfo.gov/content/pkg/PLAW-115publ90/pdf/PLAW-115publ90.pdf,H.J. Res 123,
10/29/2025 15:18:56,2018,12/22/2017,Continuing Resolution,https://www.govinfo.gov/content/pkg/PLAW-115publ96/pdf/PLAW-115publ96.pdf,H.R. 1370,
,2017,02/09/2016,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2017-BUD/pdf/BUDGET-2017-BUD.pdf,,DoD started FY17 under a CR and continued with two additional CRs before the Consolidated Appropriations Act became law in May.
,2017,09/29/2016,Continuing Resolution,https://www.congress.gov/bill/114th-congress/house-bill/5325,H.R. 5325,
,2016,02/02/2015,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2016-BUD/pdf/BUDGET-2016-BUD.pdf,,DoD started FY16 under a CR and continued with two follow on CRs before the Consolidated Appropriations Act became law in December 2015.
,2016,09/30/2015,Continuing Resolution,https://www.congress.gov/bill/114th-congress/house-bill/719,H.R. 719,
,2016,12/11/2015,Continuing Resolution,https://www.congress.gov/bill/114th-congress/house-bill/2250,H.R. 2250,
,2016,12/16/2015,Continuing Resolution,https://www.congress.gov/bill/114th-congress/house-joint-resolution/78?r=2,H.J. Res 78,
,2017,05/05/2017,Appropriation,https://www.congress.gov/bill/115th-congress/house-bill/244,H.R. 244,
,2016,12/18/2015,Appropriation,https://www.congress.gov/bill/114th-congress/house-bill/2029,H.R. 2029,
,2015,03/04/2014,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2015-BUD/pdf/BUDGET-2015-BUD.pdf,,DoD started FY15 under a CR and had two short extensions before the Consolidated and Further Continuing Appropriations Act became law in December.
,2015,09/19/2014,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-joint-resolution/124,H.J. Res 124,
,2015,12/12/2014,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-joint-resolution/130,H.J. Res 130,
,2015,12/13/2014,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-joint-resolution/131,H.J. Res 131,
,2015,12/16/2014,Appropriation,https://www.congress.gov/bill/113th-congress/house-bill/83,H.R. 83,
,2014,01/15/2014,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-joint-resolution/106,H.J. Res 106,
,2014,01/17/2014,Appropriation,https://www.congress.gov/bill/113th-congress/house-bill/3547,H.R. 3547,
,2014,04/10/2013,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2014-BUD/pdf/BUDGET-2014-BUD.pdf,,DoD started FY14 with a government shutdown that lasted 16 days. It then continued under CR until the Consolidated Appropriations Act became law in January.
,2014,09/30/2013,Government Shutdown,https://www.congress.gov/bill/113th-congress/house-bill/3210,H.R. 3210,
,2014,10/17/2013,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-bill/2775,H.R. 2775,
,2014,12/26/2013,Continuing Resolution,https://www.congress.gov/bill/113th-congress/house-joint-resolution/59,H.J. Res 59,
,2013,02/13/2012,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2013-BUD/pdf/BUDGET-2013-BUD.pdf,,DoD started FY13 with a 6 month CR to give the Murray-Ryan Supercommittee time to reach a long-term budget deal. The Supercommittee failed and sequestration took effect in the middle of the fiscal year.
,2013,03/26/2013,Appropriation,https://www.congress.gov/bill/113th-congress/house-bill/933,H.R. 933,
,2013,09/28/2012,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-joint-resolution/117,H.J. Res 117,
,2012,02/14/2011,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2012-BUD/pdf/BUDGET-2012-BUD.pdf,,DoD started FY12 under a CR and continued with multiple short-term CRs before the Consolidated Appropriations Act was signed into law in December.
,2012,09/30/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-bill/2017,H.R. 2017,
,2012,10/05/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-bill/2608,H.R. 2608,
,2012,11/18/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-bill/2112,H.R. 2112,
,2012,12/16/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-joint-resolution/94,H.J. Res 94,
,2012,12/17/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-joint-resolution/95,H.J. Res 95,
,2012,12/23/2011,Appropriation,https://www.congress.gov/bill/112th-congress/house-bill/2055,H.R. 2055,
,2011,02/01/2010,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2011-BUD/pdf/BUDGET-2011-BUD.pdf,,DoD started FY11 under a CR and continued with seven short-term CRs before the Department of Defense and Full-Year Continuing Appropriations Act became law in April.
,2011,03/02/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-joint-resolution/44,H.J. Res 44,
,2011,03/18/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-joint-resolution/48,H.J. Res 48,
,2011,04/09/2011,Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-bill/1363,H.R. 1363,
,2011,04/14/2011,Full-Year Continuing Resolution,https://www.congress.gov/bill/112th-congress/house-bill/1473,H.R. 1473,
,2011,09/30/2010,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-bill/3081,H.R. 3081,
,2011,12/04/2010,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-joint-resolution/101,H.J. Res 101,
,2011,12/18/2010,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-joint-resolution/105,H.J. Res 105,
,2011,12/22/2010,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-bill/3082,H.R. 3082,
,2010,02/26/2009,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2010-BUD/pdf/BUDGET-2010-BUD.pdf,,DoD started FY10 under a CR which was extended once before the Department of Defense Appropriations Act became law in December.
,2010,10/01/2009,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-bill/2918,H.R. 2918,
,2010,10/30/2009,Continuing Resolution,https://www.congress.gov/bill/111th-congress/house-bill/2996,H.R. 2996,
,2011,04/15/2011,Appropriation,https://www.congress.gov/bill/112th-congress/house-bill/1473,H.R. 1473,
,2010,12/19/2009,Appropriation,https://www.congress.gov/bill/111th-congress/house-bill/3326,H.R. 3326,
,2009,02/04/2008,President's Budget Delivered to Congress,https://www.gpo.gov/fdsys/pkg/BUDGET-2009-BUD/pdf/BUDGET-2009-BUD-11.pdf,,"FY09 was a normal year for DoD. While other parts of the government started under CR, DOD's appropriations passed on time."
,2009,09/30/2008,Appropriation,https://www.congress.gov/bill/110th-congress/house-bill/2638,H.R. 2638,`;

        const EVENTS = {
            "President's Budget Delivered to Congress": { color: '#58c1c6', class: 'data-pbd' },
            'Continuing Resolution': { color: '#d47371', class: 'data-cr' },
            'Full-Year Continuing Resolution': { color: '#d47371', class: 'data-cr' },
            'Appropriation': { color: '#ddb375', class: 'data-app' },
            'Government Shutdown': { color: '#7a2b2a', class: 'data-gs' }
        };

        let allEvents = [];
        let filteredEvents = [];
        let fyNotes = {};
        let currentView = 'timeline';
        let currentSort = { column: 'date', direction: 'asc' };

        // DYNAMIC Y-LABEL POSITIONING
        function positionYLabels() {
            const grid = document.querySelector('#budget-viz-wrapper .grid');
            const yLabels = document.querySelector('#budget-viz-wrapper .y-labels');
            
            if (grid && yLabels) {
                // Get the y-labels' positioning context (what it's absolutely positioned relative to)
                const labelsParent = yLabels.offsetParent || document.body;
                
                // Get absolute positions
                const gridRect = grid.getBoundingClientRect();
                const parentRect = labelsParent.getBoundingClientRect();
                
                // Calculate where grid starts relative to the labels' positioning parent
                const offsetTop = gridRect.top - parentRect.top;
                
                // Set y-labels to align with grid start
                yLabels.style.top = offsetTop + 'px';
            }
        }

        function positionLabelsAfterRender() {
            // Use requestAnimationFrame to ensure DOM is fully rendered
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    positionYLabels();
                });
            });
        }

        // UTILITY FUNCTIONS
        function parseCSV(txt) {
            const lines = txt.split('\n');
            const rows = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const cells = [];
                let cell = '', quoted = false;
                for (let c of lines[i]) {
                    if (c === '"') quoted = !quoted;
                    else if (c === ',' && !quoted) { cells.push(cell.trim()); cell = ''; }
                    else cell += c;
                }
                cells.push(cell.trim());
                if (cells.length >= 5) rows.push(cells);
            }
            return rows;
        }

        function parseDate(s) {
            const [m, d, y] = s.split('/');
            return new Date(y, m - 1, d);
        }

        function formatDate(date) {
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getPos(date, fy) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();
            
            const fyStartYear = fy - 1;
            const row = (year === fyStartYear) ? month - 1 : 11 + month;
            
            const daysInMonth = getDaysInMonth(year, month);
            const proportion = (day - 1) / (daysInMonth - 1);
            
            return (row * 4) + (proportion * 4);
        }

        function getDayOfPeriod(date, fy) {
            const start = new Date(fy - 1, 1, 1);
            return Math.floor((date - start) / (1000 * 60 * 60 * 24));
        }

        // DATA LOADING
        async function load() {
            try {
                // Use hardcoded CSV data instead of fetching
                const txt = CSV_DATA;
                const rows = parseCSV(txt);
                
                rows.forEach(r => {
                    const fy = parseInt(r[1]);
                    const dt = parseDate(r[2]);
                    if (dt && fy) {
                        allEvents.push({
                            fy: fy,
                            date: dt,
                            dateStr: r[2],
                            type: r[3],
                            url: r[4] || '',
                            bill: r[5] || ''
                        });
                    }
                    if (r[6] && !fyNotes[fy]) {
                        fyNotes[fy] = r[6].replace(/^"+|"+$/g, '');
                    }
                });

                allEvents.sort((a, b) => a.date - b.date);
                filteredEvents = [...allEvents];

                populateFilters();
                renderTimeline();
                renderTable();
                
                document.getElementById('loading').classList.add('u-hidden');
                showView('timeline');
                
                // Position labels after everything is rendered
                positionLabelsAfterRender();
                
            } catch (e) {
                document.getElementById('error').textContent = 'Error: ' + e.message;
                document.getElementById('error').classList.remove('u-hidden');
                document.getElementById('loading').classList.add('u-hidden');
            }
        }

        // VIEW TOGGLE
        function showView(view) {
            currentView = view;
            
            if (view === 'timeline') {
                document.getElementById('timeline-view').classList.remove('u-hidden');
                document.getElementById('table-view').classList.add('u-hidden');
                document.getElementById('timeline-btn').classList.add('active');
                document.getElementById('table-btn').classList.remove('active');
            } else {
                document.getElementById('timeline-view').classList.add('u-hidden');
                document.getElementById('table-view').classList.remove('u-hidden');
                document.getElementById('timeline-btn').classList.remove('active');
                document.getElementById('table-btn').classList.add('active');
            }
        }

        // TIMELINE RENDERING
        function renderTimeline() {
            const byYear = {};
            allEvents.forEach(e => {
                if (!byYear[e.fy]) byYear[e.fy] = [];
                byYear[e.fy].push(e);
            });

            const years = Object.keys(byYear).map(Number).sort((a,b)=>a-b);
            const cols = years.length + 2;

            let legendHtml = '<div class="legend">';
            legendHtml += '<div class="legend-item"><div class="legend-bar data-pbd"></div><span>President\'s Budget Delivered</span></div>';
            legendHtml += '<div class="legend-item"><div class="legend-bar data-cr"></div><span>Continuing Resolution</span></div>';
            legendHtml += '<div class="legend-item"><div class="legend-bar data-app"></div><span>Appropriation</span></div>';
            legendHtml += '<div class="legend-item"><div class="legend-bar data-gs"></div><span>Government Shutdown</span></div>';
            legendHtml += '<div class="legend-item"><div class="legend-bar eofy"></div><span>End of Fiscal Year</span></div>';
            legendHtml += '</div>';
            
            document.getElementById('legend-placeholder').innerHTML = legendHtml;

            let h = '<div class="viz-wrapper" style="--cols:' + cols + ';">';
            
            h += '<div class="x-labels">';
            years.forEach(y => {
                const note = fyNotes[y] || '';
                h += `<div class="x-label">`;
                if (note) h += `<div class="x-tooltip">${note}</div>`;
                h += `FY ${String(y).slice(-2)}</div>`;
            });
            h += '<div class="x-label static">Avg</div>';
            h += '<div class="x-label static">Ideal</div>';
            h += '</div>';
            
            h += '<div class="grid">';
            for (let r = 0; r < 18; r++) {
                for (let c = 0; c < cols; c++) {
                    const cls = (c >= years.length ? 'avg-ideal ' : '') + (r === 7 ? 'row-7' : '');
                    h += `<div class="cell ${cls}"></div>`;
                }
            }
            h += '</div>';
            
            h += '<div class="data-layer">';
            h += renderEvents(byYear, years);
            h += renderAvgIdeal(byYear, years.length);
            h += '</div>';
            
            h += '</div>';
            
            h += '<div class="y-labels">';
            ['Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb','Mar','Apr','May','Jun','Jul'].forEach(m => {
                h += `<div class="y-label">${m}</div>`;
            });
            h += '</div>';
            
            document.getElementById('viz').innerHTML = h;
            
            // Position y-labels after timeline is rendered
            positionLabelsAfterRender();
        }

        function renderEvents(byYear, years) {
            let h = '';
            const now = new Date();
            
            years.forEach((fy, col) => {
                const ev = byYear[fy];
                ev.sort((a,b) => a.date - b.date);
                
                const hasApp = ev.some(e => e.type === 'Appropriation' || e.type === 'Full-Year Continuing Resolution');
                
                for (let i = 0; i < ev.length; i++) {
                    const e = ev[i];
                    const cfg = EVENTS[e.type];
                    if (!cfg) continue;
                    
                    const y = getPos(e.date, fy);
                    const x = col * 5;
                    
                    let barH = 0;
                    if (e.type !== 'Appropriation' && e.type !== 'Full-Year Continuing Resolution') {
                        if (i < ev.length - 1) {
                            // Bar to next event
                            const nextY = getPos(ev[i+1].date, fy);
                            barH = nextY - y;
                        } else if (!hasApp) {
                            // Last event in incomplete year - bar to question mark
                            const nowY = getPos(now, fy);
                            if (nowY > y) {
                                barH = nowY - y;
                            }
                        }
                    }
                    
                    // Render bar first (if needed) as separate div
                    if (barH > 0) {
                        h += `<div class="event ${cfg.class}" style="top:${y}rem; left:${x}rem;">`;
                        h += `<div class="bar" style="height:${barH}rem;"></div>`;
                        h += `</div>`;
                    }
                    
                    // Then render marker as separate div at same position
                    h += `<div class="event ${cfg.class}" style="top:${y}rem; left:${x}rem;">`;
                    h += `<div class="marker"></div>`;
                    h += `<div class="event-tooltip">`;
                    h += `<strong>${formatDate(e.date)}</strong><br>${e.type}`;
                    if (e.bill) h += `<br><em>${e.bill}</em>`;
                    if (e.url) h += `<br><a href="${e.url}" target="_blank">Source</a>`;
                    h += `</div>`;
                    h += `</div>`;
                }
                
                if (!hasApp) {
                    const y = getPos(now, fy);
                    const x = col * 5;
                    h += `<div class="event" style="top:${y}rem; left:${x}rem;"><div class="question-mark">?</div></div>`;
                }
            });
            return h;
        }

        function renderAvgIdeal(byYear, yearCount) {
            const refFY = 2024;
            const refStart = new Date(refFY - 1, 1, 1);
            
            const avgByType = { 'pbd': [], 'cr': [], 'app': [] };
            Object.values(byYear).forEach(events => {
                // Sort events by date to ensure we get the first CR
                const sortedEvents = [...events].sort((a, b) => a.date - b.date);
                let firstCRFound = false;
                
                sortedEvents.forEach(e => {
                    const day = getDayOfPeriod(e.date, e.fy);
                    if (e.type === "President's Budget Delivered to Congress") {
                        avgByType.pbd.push(day);
                    } else if (e.type.includes('Continuing Resolution') && !firstCRFound) {
                        // Only include the first CR for this fiscal year
                        avgByType.cr.push(day);
                        firstCRFound = true;
                    } else if (e.type === 'Appropriation') {
                        avgByType.app.push(day);
                    }
                });
            });
            
            let h = '';
            
            // Average column
            const avgX = yearCount * 5;
            const avgEvents = [];
            
            ['pbd', 'cr', 'app'].forEach(type => {
                if (avgByType[type].length === 0) return;
                const avgDay = avgByType[type].reduce((a,b)=>a+b,0) / avgByType[type].length;
                const avgDate = new Date(refStart.getTime() + avgDay * 24 * 60 * 60 * 1000);
                const y = getPos(avgDate, refFY);
                const cls = type === 'pbd' ? 'data-pbd' : type === 'cr' ? 'data-cr' : 'data-app';
                const typeName = type === 'pbd' ? "President's Budget Delivered to Congress" : type === 'cr' ? 'Continuing Resolution' : 'Appropriation';
                avgEvents.push({ y, cls, type, date: avgDate, typeName });
            });
            
            // Sort by position
            avgEvents.sort((a, b) => a.y - b.y);
            
            // Render average events with bars
            avgEvents.forEach((e, i) => {
                let barH = 0;
                if (e.type !== 'app' && i < avgEvents.length - 1) {
                    barH = avgEvents[i + 1].y - e.y;
                }
                
                // Render bar first (if needed)
                if (barH > 0) {
                    h += `<div class="event ${e.cls}" style="top:${e.y}rem; left:${avgX}rem;"><div class="bar" style="height:${barH}rem;"></div></div>`;
                }
                
                // Then render marker with tooltip
                h += `<div class="event ${e.cls}" style="top:${e.y}rem; left:${avgX}rem;">`;
                h += `<div class="marker"></div>`;
                h += `<div class="event-tooltip">`;
                h += `<strong>Average: ${formatDate(e.date)}</strong><br>${e.typeName}`;
                h += `</div>`;
                h += `</div>`;
            });
            
            // Ideal column
            const idealX = (yearCount + 1) * 5;
            const idealBudget = new Date(refFY - 1, 1, 1);
            const idealApp = new Date(refFY - 1, 8, 30);
            const budgetY = getPos(idealBudget, refFY);
            const appY = getPos(idealApp, refFY);
            const barH = appY - budgetY;
            
            // Render bar first
            h += `<div class="event data-pbd" style="top:${budgetY}rem; left:${idealX}rem;"><div class="bar" style="height:${barH}rem;"></div></div>`;
            
            // Then render markers with tooltips
            h += `<div class="event data-pbd" style="top:${budgetY}rem; left:${idealX}rem;">`;
            h += `<div class="marker"></div>`;
            h += `<div class="event-tooltip">`;
            h += `<strong>Ideal: ${formatDate(idealBudget)}</strong><br>President's Budget Delivered to Congress`;
            h += `</div>`;
            h += `</div>`;
            
            h += `<div class="event data-app" style="top:${appY}rem; left:${idealX}rem;">`;
            h += `<div class="marker"></div>`;
            h += `<div class="event-tooltip">`;
            h += `<strong>Ideal: ${formatDate(idealApp)}</strong><br>Appropriation`;
            h += `</div>`;
            h += `</div>`;
            
            return h;
        }

        // TABLE RENDERING
        function populateFilters() {
            const fiscalYears = [...new Set(allEvents.map(e => e.fy))].sort((a, b) => a - b);
            const fySelect = document.getElementById('filter-fy');
            fiscalYears.forEach(fy => {
                const option = document.createElement('option');
                option.value = fy;
                option.textContent = `FY ${fy}`;
                fySelect.appendChild(option);
            });

            const eventTypes = [...new Set(allEvents.map(e => e.type))].sort();
            const eventSelect = document.getElementById('filter-event');
            eventTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                eventSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const fyFilter = document.getElementById('filter-fy').value;
            const eventFilter = document.getElementById('filter-event').value;

            filteredEvents = allEvents.filter(e => {
                if (fyFilter && e.fy !== parseInt(fyFilter)) return false;
                if (eventFilter && e.type !== eventFilter) return false;
                return true;
            });

            sortEvents();
            renderTable();
        }

        function sortEvents() {
            filteredEvents.sort((a, b) => {
                let valA, valB;
                
                if (currentSort.column === 'date') {
                    valA = a.date;
                    valB = b.date;
                } else if (currentSort.column === 'event') {
                    valA = a.type;
                    valB = b.type;
                }

                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            filteredEvents.forEach(e => {
                const cfg = EVENTS[e.type];
                if (!cfg) return;

                const tr = document.createElement('tr');
                
                // Date
                const tdDate = document.createElement('td');
                tdDate.className = 'date';
                tdDate.textContent = e.dateStr;
                tr.appendChild(tdDate);

                // Fiscal Year
                const tdFY = document.createElement('td');
                tdFY.className = 'fy';
                
                if (fyNotes[e.fy]) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'fy-with-note';
                    
                    const fyText = document.createElement('span');
                    fyText.textContent = `FY ${e.fy}`;
                    wrapper.appendChild(fyText);
                    
                    const infoIcon = document.createElement('span');
                    infoIcon.className = 'info-icon';
                    infoIcon.textContent = 'i';
                    
                    const tooltip = document.createElement('div');
                    tooltip.className = 'fy-tooltip';
                    tooltip.textContent = fyNotes[e.fy];
                    infoIcon.appendChild(tooltip);
                    
                    wrapper.appendChild(infoIcon);
                    tdFY.appendChild(wrapper);
                } else {
                    tdFY.textContent = `FY ${e.fy}`;
                }
                
                tr.appendChild(tdFY);

                // Event Type
                const tdEvent = document.createElement('td');
                tdEvent.className = `event-type ${cfg.class}`;
                tdEvent.textContent = e.type;
                tr.appendChild(tdEvent);

                // Bill Name
                const tdBill = document.createElement('td');
                tdBill.className = 'bill';
                tdBill.textContent = e.bill || '—';
                tr.appendChild(tdBill);

                // Source
                const tdSource = document.createElement('td');
                tdSource.className = 'source';
                if (e.url) {
                    const a = document.createElement('a');
                    a.href = e.url;
                    a.target = '_blank';
                    a.textContent = 'View Source →';
                    tdSource.appendChild(a);
                } else {
                    tdSource.textContent = '—';
                }
                tr.appendChild(tdSource);

                tbody.appendChild(tr);
            });

            // Update result count
            const total = allEvents.length;
            const shown = filteredEvents.length;
            const countEl = document.getElementById('result-count');
            if (shown === total) {
                countEl.textContent = `Showing all ${total} events`;
            } else {
                countEl.textContent = `Showing ${shown} of ${total} events`;
            }

            // Update sort indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === currentSort.column) {
                    th.classList.add(`sorted-${currentSort.direction}`);
                }
            });
        }

        // EVENT LISTENERS
        document.getElementById('timeline-btn').addEventListener('click', () => showView('timeline'));
        document.getElementById('table-btn').addEventListener('click', () => showView('table'));

        document.getElementById('filter-fy').addEventListener('change', applyFilters);
        document.getElementById('filter-event').addEventListener('change', applyFilters);

        document.getElementById('clear-filters').addEventListener('click', () => {
            document.getElementById('filter-fy').value = '';
            document.getElementById('filter-event').value = '';
            applyFilters();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const sortColumn = th.dataset.sort;
                
                if (currentSort.column === sortColumn) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = sortColumn;
                    currentSort.direction = 'asc';
                }

                sortEvents();
                renderTable();
            });
        });

        // Touch support for tooltips on mobile
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.addEventListener('click', function(e) {
                const infoIcon = e.target.closest('.info-icon');
                
                if (infoIcon) {
                    e.stopPropagation();
                    const tooltip = infoIcon.querySelector('.fy-tooltip');
                    if (tooltip) {
                        const isVisible = tooltip.style.opacity === '1';
                        document.querySelectorAll('.fy-tooltip').forEach(t => {
                            t.style.opacity = '0';
                            t.style.visibility = 'hidden';
                        });
                        if (!isVisible) {
                            tooltip.style.opacity = '1';
                            tooltip.style.visibility = 'visible';
                        }
                    }
                } else {
                    document.querySelectorAll('.fy-tooltip').forEach(t => {
                        t.style.opacity = '0';
                        t.style.visibility = 'hidden';
                    });
                }
            });
        }

        load();

        // Initial positioning after page loads
        window.addEventListener('load', positionLabelsAfterRender);

        // Re-position on window resize (debounced)
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(positionYLabels, 100);
        });

        // Also position when switching to timeline view
        document.getElementById('timeline-btn').addEventListener('click', () => {
            setTimeout(positionLabelsAfterRender, 50);
        });
    </script>
</body>
</html>
